<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>99 ä¹˜æ³•å¤§æŒ‘æˆ° v2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=SN+Pro:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* æ³¨éŸ³èŠ«è½é«” */
        @font-face {
            font-family: 'BpmfIansui';
            src: url('fonts/BpmfIansui-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: "SN Pro", 'BpmfIansui', -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            font-weight: 600;
            background: #FAF3E0; /* å¥¶æ²¹è‰²èƒŒæ™¯ */
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: min(20px, 3vw);
            overflow-x: hidden;
        }

        .game-container {
            position: relative;
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: min(20px, 3vw);
        }

        /* === é ‚éƒ¨çµ±è¨ˆåˆ—ï¼ˆä¸€é«”å¼ï¼‰ === */
        .stats-bar {
            display: flex;
            width: 100%;
            background: #5A6988; /* Muted Slate Blue */
            border: 6px solid #3B455E; /* Dark Border */
            border-radius: 50px;
            padding: 8px min(24px, 3vw); /* éŸ¿æ‡‰å¼ padding */
            /* Inner shadow for "inset" look + slight drop shadow */
            box-shadow: inset 0 4px 6px rgba(0,0,0,0.2), 0 6px 0 rgba(0,0,0,0.1);
            justify-content: space-between;
            align-items: center;
        }

        .stat-section {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .stat-icon {
            width: min(40px, 10vw);
            height: min(40px, 10vw);
            object-fit: contain;
            flex-shrink: 0;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.25));
        }

        .stat-text {
            display: flex;
            flex-direction: column; /* Stack Label and Value vertically */
            align-items: flex-start;
            justify-content: center;
            gap: 2px;
            line-height: 1;
            color: white;
        }

        .stat-label {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255,255,255,0.85);
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 900;
            letter-spacing: 0.5px;
            text-shadow: 1px 2px 0 rgba(0,0,0,0.2);
        }

        /* === é¡Œç›®å¡ç‰‡ === */
        .question-card-wrapper {
            position: relative;
            width: 100%;
            margin-top: min(150px, 32vw); /* å†ç¸®å° */
        }

        .mascot-container {
            position: absolute;
            top: max(-145px, -22vw); /* max é™åˆ¶å¤§è¢å¹•ä¸æœƒé£›å¤ªé«˜ */
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .mascot-image {
            width: min(240px, 45vw); /* éŸ¿æ‡‰å¼ï¼šå†ç¸®å°ä¸€é» */
            height: min(240px, 45vw);
            object-fit: contain;
            animation: mascotBounce 2s ease-in-out infinite;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
            transition: transform 0.3s ease;
        }

        .mascot-image.flipped {
            animation: mascotBounceFlipped 2s ease-in-out infinite;
        }

        @keyframes mascotBounce {
            0%, 100% { transform: translateY(0) scaleX(1); }
            50% { transform: translateY(-8px) scaleX(1); }
        }

        @keyframes mascotBounceFlipped {
            0%, 100% { transform: translateY(0) scaleX(-1); }
            50% { transform: translateY(-8px) scaleX(-1); }
        }

        .question-card {
            background: white;
            border: 6px solid #485675; /* Slate Blue */
            border-radius: 40px;
            /* ä¸Šæ–¹é ç•™ç©ºé–“çµ¦è²“é ­é·¹ï¼ŒéŸ¿æ‡‰å¼ padding */
            padding: min(100px, 20vw) 20px min(50px, 8vw) 20px;
            text-align: center;
            box-shadow: 0 10px 0 rgba(0,0,0,0.1);
            margin-top: min(40px, 10vw);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .question-text {
            font-size: min(64px, 16vw);
            font-weight: 900;
            color: #1A2B58;
            letter-spacing: -2px;
            white-space: nowrap;
        }

        /* Curved Speech Bubble Tail */
        .question-card::before {
            content: '';
            position: absolute;
            top: -38px;
            left: 20%;
            width: 40px;
            height: 40px;
            background: white;
            border-left: 6px solid #485675;
            border-top: 6px solid #485675;
            border-top-left-radius: 100%;
            /* èª¿æ•´è§’åº¦ä½¿å…¶åƒé¯Šé­šé°­ */
            transform: rotate(15deg) skewX(10deg);
            z-index: 1;
        }

        /* Mask to cover the main border where the tail connects */
        .question-card::after {
            content: '';
            position: absolute;
            top: -6px; /* Match border width */
            left: 20%;
            width: 45px; /* Slightly wider than tail */
            height: 10px;
            background: white;
            z-index: 2;
        }



        /* === ç­”æ¡ˆæŒ‰éˆ• === */
        .answers-row {
            display: flex;
            gap: 16px;
            width: 100%;
        }

        .answer-btn {
            flex: 1;
            aspect-ratio: 1 / 1;
            border: none;
            border-radius: 35px; /* éå¸¸åœ“æ½¤ */
            /* é¡¯å¼æŒ‡å®šå­—å‹ä»¥ç¢ºä¿èˆ‡é¡Œç›®ä¸€è‡´ */
            font-family: "SN Pro", sans-serif;
            color: white;
            font-size: min(64px, 18vw); /* éŸ¿æ‡‰å¼å­—é«” */
            font-weight: 900;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border-width: 5px;
            border-style: solid;
            /* æ–‡å­—æé‚Šæ•ˆæœ */
            -webkit-text-stroke: 3px; 
            paint-order: stroke fill;
        }

        /* æ‰€æœ‰æŒ‰éˆ•éƒ½æ˜¯è—è‰² */
        .answer-btn {
            background: linear-gradient(to bottom, #5DADF8, #4489D7);
            border-color: #265C96;
            -webkit-text-stroke-color: #265C96;
            box-shadow: inset 0 6px 0 rgba(255,255,255,0.35), 0 8px 0 #265C96, 0 12px 10px rgba(0,0,0,0.2);
        }

        .answer-btn:active,
        .answer-btn.pressed {
            transform: translateY(6px);
            box-shadow: inset 0 6px 0 rgba(255,255,255,0.35), 0 2px 0 #265C96;
        }

        .answer-btn.correct {
            background: linear-gradient(to bottom, #6EE08A, #4CAF65) !important;
            border-color: #2D6A3E !important;
            -webkit-text-stroke-color: #2D6A3E !important;
            box-shadow: inset 0 6px 0 rgba(255,255,255,0.35), 0 2px 0 #2D6A3E !important;
            transform: translateY(6px);
        }

        .answer-btn.wrong {
            opacity: 0.6;
        }

        /* ç­”éŒ¯æ™‚é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆï¼ˆç´…è‰²ï¼Œä¸ä¸‹å£“ï¼‰ */
        .answer-btn.reveal {
            background: linear-gradient(to bottom, #FF8A8A, #E04F4F) !important;
            border-color: #9E2A2A !important;
            -webkit-text-stroke-color: #9E2A2A !important;
            box-shadow: inset 0 6px 0 rgba(255,255,255,0.35), 0 8px 0 #9E2A2A, 0 12px 10px rgba(0,0,0,0.2) !important;
        }

        .answer-btn:disabled {
            cursor: not-allowed;
        }

        @keyframes btnPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        @keyframes btnShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* === è¨Šæ¯ === */
        .message {
            font-family: 'BpmfIansui', sans-serif;
            font-size: 24px;
            font-weight: normal;
            color: #2C3E50;
            min-height: 32px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .message img {
            width: 28px;
            height: 28px;
            vertical-align: middle;
        }

        /* === é–‹å§‹ / çµæŸç•«é¢ === */
        .screen {
            position: relative;
            width: 100%;
            text-align: center;
        }

        .screen-title {
            font-family: 'BpmfIansui', sans-serif;
            font-size: 28px;
            font-weight: normal;
            color: #2C3E50;
            margin-bottom: 20px;
        }

        .screen-subtitle {
            font-family: 'BpmfIansui', sans-serif;
            font-size: 18px;
            color: #5D6D7E;
            margin-bottom: 24px;
        }

        .final-score {
            font-size: 72px;
            font-weight: 900;
            color: #F39C12;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 8px;
        }

        .big-btn {
            width: 100%;
            height: 72px; /* Taller for better touch target and 3D effect */
            border: 5px solid;
            border-radius: 40px;
            color: white;
            font-family: 'BpmfIansui', "SN Pro", sans-serif;
            font-size: 28px;
            font-weight: normal;
            cursor: pointer;
            transition: transform 0.15s;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Text Stroke Effect */
            -webkit-text-stroke: 2px;
            paint-order: stroke fill;
            position: relative;
        }

        .big-btn:active { transform: translateY(4px); }

        .btn-start { 
            background: linear-gradient(to bottom, #6EE08A, #4CAF65);
            border-color: #2D6A3E;
            -webkit-text-stroke-color: #2D6A3E;
            box-shadow: inset 0 6px 0 rgba(255,255,255,0.35), 0 8px 0 #2D6A3E, 0 12px 10px rgba(0,0,0,0.2);
        }
        
        .btn-stats, .btn-back { 
            background: linear-gradient(to bottom, #5DADF8, #4489D7);
            border-color: #265C96;
            -webkit-text-stroke-color: #265C96;
            box-shadow: inset 0 6px 0 rgba(255,255,255,0.35), 0 8px 0 #265C96, 0 12px 10px rgba(0,0,0,0.2);
        }

        .btn-stats:active, .btn-back:active, .btn-start:active {
            box-shadow: inset 0 6px 0 rgba(255,255,255,0.35), 0 4px 0 #265C96; /* Corrected shadow offset on active */
        }

        .btn-start:active {
             box-shadow: inset 0 6px 0 rgba(255,255,255,0.35), 0 4px 0 #2D6A3E;
        }

        .hidden { display: none !important; }

        /* === è¨­å®šæŒ‰éˆ•ï¼ˆé¦–é å³ä¸Šè§’ï¼‰ === */
        .settings-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            border: 4px solid #485675;
            border-radius: 50%;
            background: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.15);
            transition: transform 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .settings-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.15); }

        /* === è¨­å®šé é¢ === */
        .settings-page {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 320px;
        }

        .mult-toggle {
            aspect-ratio: 1;
            border: 5px solid #ccc;
            border-radius: 16px;
            background: white;
            font-family: 'BpmfIansui', "SN Pro", sans-serif;
            font-size: 32px;
            font-weight: 600;
            color: #999;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }

        .mult-toggle.active {
            border-color: #4CAF65;
            background: linear-gradient(to bottom, #6EE08A, #4CAF65);
            color: white;
            -webkit-text-stroke: 1.5px #2D6A3E;
            paint-order: stroke fill;
            box-shadow: 0 4px 0 #2D6A3E;
        }

        .mult-toggle:active { transform: translateY(2px); }

        .settings-actions {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 320px;
        }

        .settings-actions button {
            flex: 1;
            padding: 10px;
            border: 3px solid #485675;
            border-radius: 20px;
            background: white;
            font-family: 'BpmfIansui', sans-serif;
            font-size: 14px;
            color: #485675;
            cursor: pointer;
        }

        .settings-actions button:active { background: #f0f0f0; }

        .btn-settings {
            background: linear-gradient(to bottom, #FFB347, #F39C12);
            border-color: #C87000;
            -webkit-text-stroke-color: #C87000;
            box-shadow: inset 0 6px 0 rgba(255,255,255,0.35), 0 8px 0 #C87000, 0 12px 10px rgba(0,0,0,0.2);
        }

        .btn-settings:active {
            box-shadow: inset 0 6px 0 rgba(255,255,255,0.35), 0 4px 0 #C87000;
        }

        /* === é€£æ“Š COMBO ç‰¹æ•ˆ === */
        .combo-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: 900;
            color: #F39C12;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.2);
            animation: comboAnim 0.8s forwards;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes comboAnim {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            40% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -80%) scale(1); }
        }

        /* === æ˜Ÿæ˜Ÿå™´ç™¼ === */
        .star {
            position: fixed;
            pointer-events: none;
            font-size: 24px;
            animation: starBurst 0.7s forwards;
            z-index: 99;
        }

        @keyframes starBurst {
            0% { opacity: 1; transform: translate(0,0) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
        }

        /* === æ”¾å±ç‰¹æ•ˆ === */
        .fart-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .fart-main {
            font-size: 100px;
            opacity: 0;
            transform: scale(0);
        }

        .fart-main.active {
            animation: fartPop 0.7s ease-out forwards;
        }

        @keyframes fartPop {
            0% { opacity: 1; transform: scale(0) rotate(-10deg); }
            30% { opacity: 1; transform: scale(1.3) rotate(5deg); }
            100% { opacity: 0; transform: scale(1.5) translateY(-40px); }
        }

        .fart-particle {
            position: absolute;
            font-size: 36px;
            opacity: 0;
        }

        .fart-particle.active {
            animation: fartFloat 0.7s ease-out forwards;
        }

        @keyframes fartFloat {
            0% { opacity: 0.8; transform: translate(0,0) scale(0.5); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(1) rotate(var(--rot)); }
        }

        /* === çµ±è¨ˆé é¢ === */
        .stats-page {
            width: 100%;
            max-width: 400px;
        }

        .stats-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .stats-tab {
            flex: 1;
            height: 56px;
            border: 4px solid #8B9DC3;
            border-radius: 28px;
            background: linear-gradient(to bottom, #B8C6DB, #A0B0C8);
            font-family: 'BpmfIansui', "SN Pro", sans-serif;
            font-size: 20px;
            font-weight: normal;
            color: #5A6988;
            cursor: pointer;
            box-shadow: inset 0 4px 0 rgba(255,255,255,0.3), 0 6px 0 #8B9DC3, 0 8px 8px rgba(0,0,0,0.15);
            transition: transform 0.1s;
        }

        .stats-tab:active {
            transform: translateY(4px);
            box-shadow: inset 0 4px 0 rgba(255,255,255,0.3), 0 2px 0 #8B9DC3;
        }

        .stats-tab.active {
            background: linear-gradient(to bottom, #5DADF8, #4489D7);
            border-color: #265C96;
            color: white;
            box-shadow: inset 0 4px 0 rgba(255,255,255,0.35), 0 6px 0 #265C96, 0 8px 8px rgba(0,0,0,0.2);
            -webkit-text-stroke: 1px #265C96;
            paint-order: stroke fill;
        }

        .stats-box {
            background: white;
            border: 6px solid #485675;
            border-radius: 40px;
            padding: 20px;
            height: 300px;
            box-shadow: 0 10px 0 rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .stats-scroll {
            height: 100%;
            overflow-y: auto;
            padding-right: 10px;
        }
        .stats-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .stats-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .stats-scroll::-webkit-scrollbar-thumb {
            background: #485675;
            border-radius: 3px;
        }

        .recent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #F5F7FA;
            border-radius: 16px;
            margin-bottom: 8px;
        }

        .recent-score {
            font-size: 28px;
            font-weight: bold;
            color: #1A2B58;
        }

        .recent-time {
            font-size: 14px;
            color: #5A6988;
        }

        .no-data {
            font-family: 'BpmfIansui', sans-serif;
            text-align: center;
            color: #5A6988;
            padding: 50px 20px;
            font-size: 22px;
        }

        /* è‚¡ç¥¨é¢¨æ ¼åˆ†æ•¸ç´€éŒ„ï¼ˆç›´æ¢ï¼‰ */
        .stock-container {
            display: flex;
            background: white;
            border: 6px solid #485675;
            border-radius: 40px;
            overflow: hidden;
            box-shadow: 0 10px 0 rgba(0,0,0,0.1);
        }
        .stock-yaxis {
            width: 45px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px 8px 45px 12px;
            border-right: 2px solid #485675;
            font-size: 13px;
            font-weight: bold;
            color: #485675;
            text-align: right;
        }
        .stock-scroll-wrapper {
            flex: 1;
            padding: 10px 15px 15px 0;
            overflow: hidden;
        }
        .stock-scroll {
            height: 100%;
            overflow-x: auto;
            overflow-y: hidden;
        }
        .stock-scroll::-webkit-scrollbar {
            height: 6px;
        }
        .stock-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .stock-scroll::-webkit-scrollbar-thumb {
            background: #485675;
            border-radius: 3px;
        }
        .stock-chart {
            display: flex;
            align-items: flex-end;
            height: 275px;
            padding: 0 20px 30px;
            min-width: fit-content;
        }
        .stock-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            height: 100%;
            position: relative;
            flex-shrink: 0;
        }
        .stock-bar-area {
            flex: 1;
            width: 100%;
            position: relative;
        }
        .stock-bar {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            background: linear-gradient(to top, #5A6988, #7889A8);
            border: 3px solid #485675;
            border-radius: 10px;
            box-shadow: 0 3px 0 #3B455E;
        }
        .stock-avg-line {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 44px;
            height: 4px;
            background: #E74C3C;
            border-radius: 2px;
        }
        .stock-date {
            font-family: 'BpmfIansui', sans-serif;
            font-size: 15px;
            font-weight: bold;
            color: #485675;
            position: absolute;
            bottom: -28px;
            white-space: nowrap;
        }
        .stock-value {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: #1A2B58;
            font-weight: bold;
            white-space: nowrap;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 8px;
        }

        .reset-btn-small {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 12px;
            background: transparent;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .reset-btn-small:hover {
            opacity: 1;
        }

        /* ç¢ºèªå½ˆçª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-box {
            background: white;
            border: 6px solid #485675;
            border-radius: 40px;
            padding: 30px 40px;
            box-shadow: 0 10px 0 rgba(0,0,0,0.1);
            text-align: center;
            max-width: 300px;
        }
        .modal-owl {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 16px;
        }
        .modal-text {
            font-family: 'BpmfIansui', sans-serif;
            font-size: 28px;
            color: #1A2B58;
            margin-bottom: 24px;
        }
        .modal-buttons {
            display: flex;
            gap: 12px;
        }
        .modal-btn {
            flex: 1;
            height: 50px;
            border: 4px solid;
            border-radius: 25px;
            font-family: 'BpmfIansui', "SN Pro", sans-serif;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .modal-btn:active {
            transform: translateY(3px);
        }
        .modal-cancel {
            background: linear-gradient(to bottom, #B8C6DB, #A0B0C8);
            border-color: #8B9DC3;
            color: #5A6988;
            box-shadow: 0 4px 0 #8B9DC3;
        }
        .modal-cancel:active {
            box-shadow: 0 1px 0 #8B9DC3;
        }
        .modal-confirm {
            background: linear-gradient(to bottom, #E74C3C, #C0392B);
            border-color: #C0392B;
            color: white;
            box-shadow: 0 4px 0 #922B21;
        }
        .modal-confirm:active {
            box-shadow: 0 1px 0 #922B21;
        }

        /* ç‰ˆæ¬Šè³‡è¨Š */
        .credits {
            position: fixed;
            bottom: 8px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 11px;
            color: #999;
        }
        .credits a {
            color: #888;
            text-decoration: none;
        }
        .credits a:hover {
            text-decoration: underline;
        }

        /* === éŸ¿æ‡‰å¼ï¼ˆ280px ä»¥ä¸‹æ‰ç¸®å°ï¼ŒSafari ç®—å‡º 314pxï¼‰ === */
        @media (max-width: 280px) {
            .question-text { font-size: 40px; }
            .answer-btn { aspect-ratio: 1 / 0.85; font-size: 28px; }
            .mascot-image { width: 80px; height: 80px; }
            .mascot-container { top: -48px; }
            .question-card { margin-top: 40px; padding: 48px 20px 24px; }
        }
    </style>
</head>
<body>
    <!-- æ”¾å±ç‰¹æ•ˆ -->
    <div class="fart-overlay" id="fartOverlay">
        <div class="fart-main" id="fartMain">ğŸ’¨</div>
    </div>

    <div class="game-container" id="gameContainer">

        <!-- ===== é–‹å§‹ç•«é¢ ===== -->
        <div class="screen" id="startScreen">
            <!-- è¨­å®šæŒ‰éˆ•ï¼ˆå³ä¸Šè§’ï¼‰ -->
            <button class="settings-btn" onclick="showSettings()">âš™ï¸</button>
            <div class="mascot-container" style="position:relative; top:0; left:0; transform:none; margin-bottom:16px;">
                <img id="mascotStart" class="mascot-image" src="" alt="è²“é ­é·¹">
            </div>
            <div class="screen-title">ğŸ¯ 99 ä¹˜æ³•å¤§æŒ‘æˆ°</div>
            <div class="screen-subtitle">30 ç§’å…§ç­”å°è¶Šå¤šè¶Šå¥½ï¼</div>
            <button class="big-btn btn-start" onclick="startGame()">ğŸš€ é–‹å§‹éŠæˆ²</button>
            <button class="big-btn btn-stats" onclick="showStats()">ğŸ“Š æŸ¥çœ‹çµ±è¨ˆ</button>
        </div>

        <!-- ===== éŠæˆ²ä¸­ç•«é¢ ===== -->
        <div class="hidden" id="playScreen" style="margin-top: 20px; width: 100%;">
            <div class="stats-bar">
                <div class="stat-section">
                    <img class="stat-icon" src="images/icon_timer.webp" alt="Timer">
                    <div class="stat-text">
                        <span class="stat-label">Time:</span>
                        <span class="stat-value"><span id="timer">30</span>s</span>
                    </div>
                </div>
                <div class="stat-section">
                    <img class="stat-icon" src="images/icon_trophy.webp" alt="Trophy">
                    <div class="stat-text">
                        <span class="stat-label">Score:</span>
                        <span class="stat-value" id="score">0</span>
                    </div>
                </div>
                <div class="stat-section">
                    <img class="stat-icon" src="images/icon_lightning.webp" alt="Combo">
                    <div class="stat-text">
                        <span class="stat-label">Combo:</span>
                        <span class="stat-value">Ã—<span id="streak">0</span></span>
                    </div>
                </div>
            </div>

            <div class="question-card-wrapper">
                <div class="mascot-container">
                    <img id="mascotPlay" class="mascot-image" src="" alt="è²“é ­é·¹">
                </div>
                <div class="question-card">
                    <div class="question-text" id="question">9 Ã— 7 = ?</div>
                </div>
            </div>

            <div class="message" id="message"></div>

            <div class="answers-row" id="answers">
                <button class="answer-btn" onclick="checkAnswer(0)">63</button>
                <button class="answer-btn" onclick="checkAnswer(1)">54</button>
                <button class="answer-btn" onclick="checkAnswer(2)">72</button>
            </div>
        </div>

        <!-- ===== çµæŸç•«é¢ ===== -->
        <div class="screen hidden" id="endScreen">
            <div class="mascot-container" style="position:relative; top:0; left:0; transform:none; margin-bottom:16px;">
                <img id="mascotEnd" class="mascot-image" src="" alt="è²“é ­é·¹">
            </div>
            <div class="screen-title">ğŸ‰ éŠæˆ²çµæŸï¼</div>
            <div class="final-score" id="finalScore">0</div>
            <div class="screen-subtitle" id="endMessage">å¤ªæ£’äº†ï¼</div>
            <button class="big-btn btn-start" onclick="startGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
            <button class="big-btn btn-stats" onclick="showStats()">ğŸ“Š æŸ¥çœ‹çµ±è¨ˆ</button>
        </div>

        <!-- ===== çµ±è¨ˆé é¢ ===== -->
        <div class="stats-page hidden" id="statsScreen">
            <div class="stats-header">
                <div class="screen-title">ğŸ“Š å­¸ç¿’çµ±è¨ˆ</div>
                <button class="reset-btn-small" onclick="confirmReset()">ğŸ—‘ï¸</button>
            </div>
            <div class="stats-tabs">
                <button class="stats-tab active" onclick="switchTab('recent')">æœ€è¿‘ç´€éŒ„</button>
                <button class="stats-tab" onclick="switchTab('chart')">æ¯æ—¥åœ–è¡¨</button>
            </div>
            <div class="stats-box" id="recentBox">
                <div class="stats-scroll" id="recentList">
                    <div class="no-data" id="noRecentData">é‚„æ²’æœ‰éŠæˆ²ç´€éŒ„</div>
                </div>
            </div>
            <div class="hidden" id="chartContainer">
                <div class="stock-container">
                    <div class="stock-yaxis" id="stockYaxis"></div>
                    <div class="stock-scroll-wrapper">
                        <div class="stock-scroll">
                            <div class="stock-chart" id="stockChart"></div>
                        </div>
                    </div>
                </div>
                <div class="no-data" id="noScoreData">é‚„æ²’æœ‰éŠæˆ²ç´€éŒ„</div>
            </div>
            <button class="big-btn btn-back" onclick="hideStats()" style="margin-top: 20px;">â† è¿”å›</button>
        </div>

        <!-- ===== è¨­å®šé é¢ ===== -->
        <div class="settings-page hidden" id="settingsScreen">
            <div class="mascot-container" style="position:relative; top:0; left:0; transform:none; margin-bottom:16px;">
                <img class="mascot-image" src="images/owl_delighted.webp" alt="è²“é ­é·¹">
            </div>
            <div class="screen-title">âš™ï¸ ç·´ç¿’è¨­å®š</div>
            <div class="screen-subtitle">é¸æ“‡è¦ç·´ç¿’çš„ä¹˜æ³•è¡¨</div>
            <div class="settings-grid" id="settingsGrid">
                <!-- 2-9 çš„ä¹˜æ³•è¡¨ toggle -->
            </div>
            <div class="settings-actions">
                <button onclick="selectAllMults(false)">å–æ¶ˆå…¨é¸</button>
                <button onclick="selectAllMults(true)">å…¨é¸</button>
            </div>
            <button class="big-btn btn-settings" onclick="saveSettings()" style="margin-top: 12px;">âœ“ å„²å­˜</button>
        </div>
    </div>

    <!-- ç¢ºèªå½ˆçª— -->
    <div class="modal-overlay hidden" id="confirmModal">
        <div class="modal-box">
            <img class="modal-owl" id="modalOwl" src="images/owl_surprised.webp" alt="è²“é ­é·¹">
            <div class="modal-text" id="modalText">åˆªé™¤å—ï¼Ÿ</div>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-confirm" id="modalConfirm">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <footer class="credits">
        å­—é«”ï¼š<a href="https://github.com/AaronKow/sn-pro" target="_blank">SN Pro</a> by Aaron Koã€<a href="https://github.com/ButTaiwan/bpmfvs" target="_blank">æ³¨éŸ³èŠ«è½</a> by But Ko
    </footer>

    <script src="strings.js"></script>
    <script>
        // ===== éŠæˆ²ç‹€æ…‹ =====
        let timeLeft = 30;
        let score = 0;
        let streak = 0;
        let currentAnswer = 0;
        let currentNum1 = 0;
        let currentNum2 = 0;
        let timerInterval = null;
        let isPlaying = false;
        let isLocked = false;
        let timeExpired = false;
        let questionStartTime = 0;
        const SLOW_ANSWER_THRESHOLD = 5000;
        let usedQuestions = new Set();
        let nextFromErrorPool = true;

        // ===== ä¹˜æ³•è¡¨è¨­å®š =====
        const SETTINGS_KEY = 'mathgame_mults';
        let enabledMults = loadSettings();

        function loadSettings() {
            try {
                const saved = localStorage.getItem(SETTINGS_KEY);
                if (saved) {
                    const arr = JSON.parse(saved);
                    if (Array.isArray(arr) && arr.length > 0) return new Set(arr);
                }
            } catch (e) {}
            return new Set([2, 3, 4, 5, 6, 7, 8, 9]); // é è¨­å…¨é¸
        }

        function saveSettingsToStorage() {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify([...enabledMults]));
        }

        function showSettings() {
            alert('showSettings called!');
            playSound('tap');
            showScreen('settingsScreen');
            renderSettingsGrid();
        }

        function renderSettingsGrid() {
            const grid = document.getElementById('settingsGrid');
            grid.innerHTML = '';
            for (let i = 2; i <= 9; i++) {
                const btn = document.createElement('button');
                btn.className = 'mult-toggle' + (enabledMults.has(i) ? ' active' : '');
                btn.textContent = i;
                btn.onclick = () => toggleMult(i, btn);
                grid.appendChild(btn);
            }
        }

        function toggleMult(num, btn) {
            playSound('tap');
            if (enabledMults.has(num)) {
                if (enabledMults.size > 1) { // è‡³å°‘è¦ç•™ä¸€å€‹
                    enabledMults.delete(num);
                    btn.classList.remove('active');
                }
            } else {
                enabledMults.add(num);
                btn.classList.add('active');
            }
        }

        function selectAllMults(selectAll) {
            playSound('tap');
            if (selectAll) {
                enabledMults = new Set([2, 3, 4, 5, 6, 7, 8, 9]);
            } else {
                enabledMults = new Set([2]); // è‡³å°‘ä¿ç•™ä¸€å€‹
            }
            renderSettingsGrid();
        }

        function saveSettings() {
            playSound('tap');
            saveSettingsToStorage();
            showScreen('startScreen');
        }

        // ===== å‰ç¥¥ç‰©ï¼ˆæœƒæ›åœ–çš„è²“é ­é·¹ï¼‰=====
        const mascotWrongImage = 'images/owl_shy.webp';
        const preloadWrongImg = new Image();
        preloadWrongImg.src = mascotWrongImage;

        const mascotImages = [
            'images/owl_kiss.webp',
            'images/owl_silly.webp',
            'images/owl_flying.webp',
            'images/owl_delighted.webp',
            'images/owl_smiling.webp',
            'images/owl_puffcheeks.webp',
            'images/owl_surprised.webp',
            'images/owl_dizzy.webp'
        ];
        let currentMascotIndex = 0;
        let mascotWrongTimeout = null;

        function getAllMascots() {
            return document.querySelectorAll('.mascot-image');
        }

        function setAllMascots(src) {
            getAllMascots().forEach(img => img.src = src);
        }

        // è²“é ­é·¹éš¨æ©Ÿå·¦å³ç¿»è½‰
        function randomFlipMascot() {
            getAllMascots().forEach(img => {
                if (Math.random() < 0.5) {
                    img.classList.toggle('flipped');
                }
            });
            // 3-6 ç§’å¾Œå†ç¿»
            setTimeout(randomFlipMascot, 3000 + Math.random() * 3000);
        }
        setTimeout(randomFlipMascot, 2000);

        function initMascot() {
            // é è¼‰æ‰€æœ‰åœ–ç‰‡
            mascotImages.forEach(src => { const img = new Image(); img.src = src; });
            setAllMascots(mascotImages[0]);
        }
        initMascot();

        // æ›åˆ°ä¸‹ä¸€å¼µæ­£å¸¸åœ–
        function nextMascot() {
            currentMascotIndex = (currentMascotIndex + 1) % mascotImages.length;
            setAllMascots(mascotImages[currentMascotIndex]);
        }

        // ç­”éŒ¯ï¼šé¡¯ç¤ºæ”¾å±åœ–ï¼Œç„¶å¾Œæ›ä¸‹ä¸€å¼µæ­£å¸¸åœ–
        function showMascotWrong() {
            if (mascotWrongTimeout) clearTimeout(mascotWrongTimeout);
            setAllMascots(mascotWrongImage);
            mascotWrongTimeout = setTimeout(() => {
                nextMascot(); // æ”¾å±å¾Œæ›ä¸‹ä¸€å¼µ
                mascotWrongTimeout = null;
            }, 1000);
        }

        // ===== éŸ³æ•ˆ =====
        const sounds = {
            tap: [new Audio('sounds/tap-1.mp3'), new Audio('sounds/tap-2.mp3')],
            good: new Audio('sounds/good-1.mp3'),
            combo: new Audio('sounds/good-2.mp3'),
            bad: [new Audio('sounds/bad-1.mp3'), new Audio('sounds/bad-2.mp3')]
        };

        function playSound(type) {
            const sound = sounds[type];
            if (Array.isArray(sound)) {
                const s = sound[Math.floor(Math.random() * sound.length)];
                s.currentTime = 0;
                s.play().catch(() => {});
            } else if (sound) {
                sound.currentTime = 0;
                sound.play().catch(() => {});
            }
        }

        // ===== æ”¾å±ç‰¹æ•ˆ =====
        function showFart() {
            const overlay = document.getElementById('fartOverlay');
            const main = document.getElementById('fartMain');
            overlay.querySelectorAll('.fart-particle').forEach(p => p.remove());
            main.classList.remove('active');
            void main.offsetWidth;
            main.classList.add('active');

            const particles = ['ğŸ’¨', 'ğŸ’©', 'â˜ï¸', 'ğŸŒ«ï¸'];
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'fart-particle';
                particle.textContent = particles[Math.floor(Math.random() * particles.length)];
                particle.style.setProperty('--tx', `${(Math.random() - 0.5) * 200}px`);
                particle.style.setProperty('--ty', `${-50 - Math.random() * 100}px`);
                particle.style.setProperty('--rot', `${(Math.random() - 0.5) * 60}deg`);
                particle.style.animationDelay = `${Math.random() * 0.2}s`;
                overlay.appendChild(particle);
                requestAnimationFrame(() => particle.classList.add('active'));
                setTimeout(() => particle.remove(), 1000);
            }
        }

        // ===== LocalStorage =====
        const STATS_KEY = 'multiplyGameStats';
        const SCORES_KEY = 'multiplyGameScores';
        const ERROR_POOL_KEY = 'multiplyGameErrorPool';

        function loadStats() {
            const saved = localStorage.getItem(STATS_KEY);
            if (saved) return JSON.parse(saved);
            const stats = {};
            for (let i = 2; i <= 9; i++)
                for (let j = 1; j <= 9; j++)
                    stats[`${i}x${j}`] = { appeared: 0, errors: 0 };
            return stats;
        }
        function saveStats(stats) { localStorage.setItem(STATS_KEY, JSON.stringify(stats)); }
        function loadScores() { const s = localStorage.getItem(SCORES_KEY); return s ? JSON.parse(s) : []; }
        function saveScores(scores) { localStorage.setItem(SCORES_KEY, JSON.stringify(scores)); }
        function loadErrorPool() { const s = localStorage.getItem(ERROR_POOL_KEY); return s ? new Set(JSON.parse(s)) : new Set(); }
        function saveErrorPool(pool) { localStorage.setItem(ERROR_POOL_KEY, JSON.stringify([...pool])); }

        function recordAnswer(num1, num2, isCorrect) {
            const stats = loadStats();
            const key = `${num1}x${num2}`;
            if (stats[key]) { stats[key].appeared++; if (!isCorrect) stats[key].errors++; }
            saveStats(stats);
            const pool = loadErrorPool();
            isCorrect ? pool.delete(key) : pool.add(key);
            saveErrorPool(pool);
        }

        function recordScore(finalScore) {
            const scores = loadScores();
            // æ–°æ ¼å¼ï¼šå­˜æ™‚é–“æˆ³
            scores.push({ score: finalScore, time: Date.now() });
            saveScores(scores);
        }

        // ===== æ™ºæ…§å‡ºé¡Œ =====
        function generateWeightedQuestion() {
            const errorPoolSet = loadErrorPool();
            const errorPool = [], normalPool = [];
            const maxQuestions = enabledMults.size * 9;
            if (usedQuestions.size >= maxQuestions) usedQuestions.clear();

            for (const i of enabledMults) {
                for (let j = 1; j <= 9; j++) {
                    const key = `${i}x${j}`;
                    if (usedQuestions.has(key)) continue;
                    (errorPoolSet.has(key) ? errorPool : normalPool).push({ num1: i, num2: j });
                }
            }

            let pool;
            if (nextFromErrorPool && errorPool.length > 0) pool = errorPool;
            else if (!nextFromErrorPool && normalPool.length > 0) pool = normalPool;
            else pool = errorPool.length > 0 ? errorPool : normalPool;
            nextFromErrorPool = !nextFromErrorPool;

            const selected = pool[Math.floor(Math.random() * pool.length)];
            usedQuestions.add(`${selected.num1}x${selected.num2}`);
            return selected;
        }

        // ===== ç•«é¢åˆ‡æ› =====
        function showScreen(id) {
            ['startScreen', 'playScreen', 'endScreen', 'statsScreen', 'settingsScreen'].forEach(s => {
                document.getElementById(s).classList.toggle('hidden', s !== id);
            });
        }

        // ===== éŠæˆ²æµç¨‹ =====
        function startGame() {
            playSound('tap');
            timeLeft = 30;
            score = 0;
            streak = 0;
            isPlaying = true;
            isLocked = false;
            timeExpired = false;
            usedQuestions.clear();
            nextFromErrorPool = true;

            showScreen('playScreen');
            updateDisplay();
            generateQuestion();
            document.getElementById('message').innerHTML = `<img src="images/icon_timer.webp"> ${STRINGS.hurryUp}`;

            timerInterval = setInterval(() => {
                timeLeft--;
                updateDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timeExpired = true;
                    document.getElementById('message').innerHTML = `<img src="images/icon_timer.webp"> ${STRINGS.lastQuestion}`;
                }
            }, 1000);
        }

        function generateQuestion() {
            const q = generateWeightedQuestion();
            currentNum1 = q.num1;
            currentNum2 = q.num2;
            const correct = currentNum1 * currentNum2;

            document.getElementById('question').textContent = `${currentNum1} Ã— ${currentNum2} = ?`;

            const answers = [correct];
            while (answers.length < 3) {
                const wrong = correct + (Math.floor(Math.random() * 20) - 10);
                if (wrong > 0 && wrong <= 81 && !answers.includes(wrong)) answers.push(wrong);
            }

            // æ‰“äº‚
            for (let i = answers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [answers[i], answers[j]] = [answers[j], answers[i]];
            }

            currentAnswer = answers.indexOf(correct);

            const btns = document.querySelectorAll('.answer-btn');
            btns.forEach((btn, i) => {
                btn.textContent = answers[i];
                btn.className = 'answer-btn';
                btn.disabled = false;
            });

            isLocked = false;
            questionStartTime = Date.now();
        }

        function checkAnswer(index) {
            if (!isPlaying || isLocked) return;
            isLocked = true;

            const btns = document.querySelectorAll('.answer-btn');
            const clicked = btns[index];
            clicked.classList.add('pressed'); // æŒ‰ä¸‹ä¿æŒæŒ‰ä¸‹ç‹€æ…‹

            if (index === currentAnswer) {
                clicked.classList.add('correct'); // ç­”å°è®Šç¶ è‰²
                const answerTime = Date.now() - questionStartTime;
                const isSlow = answerTime > SLOW_ANSWER_THRESHOLD;
                recordAnswer(currentNum1, currentNum2, !isSlow);

                streak++;
                const points = streak > 1 ? 20 : 10;
                score += points;
                updateDisplay();

                playSound(streak > 1 ? 'combo' : 'good');
                nextMascot(); // ç­”å°æ›ä¸‹ä¸€å¼µ
                createStars(clicked);
                if (streak > 1) showCombo(streak);

                document.getElementById('message').innerHTML =
                    streak > 1 ? `<img src="images/icon_lightning.webp"> ${streak} ${STRINGS.combo}${STRINGS.correct}${points}` : `âœ… ${STRINGS.correct}${points}`;

                btns.forEach(b => b.disabled = true);
                setTimeout(() => {
                    if (timeExpired) endGame();
                    else if (isPlaying) { generateQuestion(); document.getElementById('message').innerHTML = ''; }
                }, 400);
            } else {
                clicked.classList.add('wrong');
                btns[currentAnswer].classList.add('reveal'); // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆï¼ˆç´…è‰²ï¼Œä¸ä¸‹å£“ï¼‰
                playSound('bad');
                showFart();
                showMascotWrong();
                streak = 0;
                recordAnswer(currentNum1, currentNum2, false);

                const correctValue = currentNum1 * currentNum2;
                document.getElementById('message').innerHTML = `âŒ ${STRINGS.wrongAnswer} ${correctValue}`;

                btns.forEach(b => b.disabled = true);
                setTimeout(() => {
                    if (timeExpired) endGame();
                    else if (isPlaying) { generateQuestion(); document.getElementById('message').innerHTML = ''; }
                }, 700);
            }
        }

        function createStars(btn) {
            const rect = btn.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const emojis = ['â­', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«'];

            for (let i = 0; i < 6; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                const angle = (Math.PI * 2 / 6) * i;
                const dist = 40 + Math.random() * 30;
                star.style.left = cx + 'px';
                star.style.top = cy + 'px';
                star.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
                star.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
                document.body.appendChild(star);
                setTimeout(() => star.remove(), 700);
            }
        }

        function showCombo(n) {
            const el = document.createElement('div');
            el.className = 'combo-popup';
            el.textContent = `${n} COMBO!`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function updateDisplay() {
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('score').textContent = score;
            document.getElementById('streak').textContent = streak;
        }

        function endGame() {
            isPlaying = false;
            clearInterval(timerInterval);
            recordScore(score);

            document.getElementById('finalScore').textContent = score;
            document.getElementById('endMessage').textContent = getEndMessage(score);

            showScreen('endScreen');
        }

        // ===== çµ±è¨ˆé é¢ =====
        function showStats() {
            playSound('tap');
            showScreen('statsScreen');
            switchTab('recent');
        }

        function hideStats() {
            playSound('tap');
            showScreen('startScreen');
        }

        function switchTab(tab) {
            playSound('tap');
            const tabs = document.querySelectorAll('.stats-tab');
            tabs[0].classList.toggle('active', tab === 'recent');
            tabs[1].classList.toggle('active', tab === 'chart');
            document.getElementById('recentBox').classList.toggle('hidden', tab !== 'recent');
            document.getElementById('chartContainer').classList.toggle('hidden', tab !== 'chart');

            if (tab === 'recent') renderRecentList();
            else renderScoreChart();
        }

        function renderRecentList() {
            const rawScores = loadScores();
            const list = document.getElementById('recentList');
            const noData = document.getElementById('noRecentData');

            // ç›¸å®¹èˆŠæ ¼å¼
            const scores = rawScores.map(s =>
                typeof s === 'number' ? { score: s, time: Date.now() } : s
            );

            list.querySelectorAll('.recent-item').forEach(el => el.remove());
            if (!scores.length) { noData.style.display = 'block'; return; }
            noData.style.display = 'none';

            // æŒ‰æ™‚é–“æ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰ï¼Œå–æœ€è¿‘30ç­†
            const recent = [...scores].sort((a, b) => b.time - a.time).slice(0, 30);

            recent.forEach(item => {
                const date = new Date(item.time);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;

                const div = document.createElement('div');
                div.className = 'recent-item';
                div.innerHTML = `
                    <div class="recent-score">${item.score}</div>
                    <div class="recent-time">${dateStr} ${timeStr}</div>
                `;
                list.appendChild(div);
            });
        }

        function renderScoreChart() {
            const rawScores = loadScores();
            const container = document.getElementById('stockChart');
            const yaxis = document.getElementById('stockYaxis');
            const noData = document.getElementById('noScoreData');
            container.innerHTML = '';
            yaxis.innerHTML = '';

            // ç›¸å®¹èˆŠæ ¼å¼ï¼ˆç´”æ•¸å­—ï¼‰å’Œæ–°æ ¼å¼ï¼ˆç‰©ä»¶ï¼‰
            const scores = rawScores.map(s =>
                typeof s === 'number' ? { score: s, time: Date.now() } : s
            );

            if (!scores.length) {
                noData.style.display = 'block';
                document.querySelector('.stock-container').style.display = 'none';
                return;
            }
            noData.style.display = 'none';
            document.querySelector('.stock-container').style.display = 'flex';

            // æ”¶é›†æ‰€æœ‰æœ‰åˆ†æ•¸çš„æ—¥æœŸ
            const dateSet = new Set();
            scores.forEach(s => {
                const key = new Date(s.time).toISOString().split('T')[0];
                dateSet.add(key);
            });
            const sortedDates = Array.from(dateSet).sort();

            // æŒ‰æ—¥æœŸåˆ†çµ„
            const byDate = {};
            sortedDates.forEach(d => byDate[d] = []);
            scores.forEach(s => {
                const key = new Date(s.time).toISOString().split('T')[0];
                if (byDate[key]) byDate[key].push(s.score);
            });

            // æ‰¾å‡ºå…¨å±€æœ€é«˜åˆ†ï¼ˆç”¨æ–¼è¨ˆç®—æ¯”ä¾‹ï¼‰
            const allScores = scores.map(s => s.score);
            const globalMax = Math.ceil(Math.max(...allScores, 100) * 1.1);

            // æ‰¾å‡ºæœ€é«˜åˆ†æ˜¯å“ªå¤©
            let crownDate = null;
            let crownScore = 0;
            Object.entries(byDate).forEach(([date, dayScores]) => {
                if (dayScores.length > 0) {
                    const high = Math.max(...dayScores);
                    if (high > crownScore) {
                        crownScore = high;
                        crownDate = date;
                    }
                }
            });

            // æ¸²æŸ“ Y è»¸åˆ»åº¦
            const ticks = 5;
            for (let i = ticks; i >= 0; i--) {
                const val = Math.round(globalMax * i / ticks);
                const div = document.createElement('div');
                div.textContent = val;
                yaxis.appendChild(div);
            }

            // æ¸²æŸ“æ¯ä¸€å¤©çš„ç›´æ¢
            Object.entries(byDate).forEach(([date, dayScores]) => {
                const div = document.createElement('div');
                div.className = 'stock-day';

                const dateStr = date.slice(5).replace('-', '/'); // "02/12"

                if (dayScores.length === 0) {
                    div.innerHTML = `
                        <div class="stock-bar-area">
                            <div class="stock-bar empty"></div>
                        </div>
                        <div class="stock-date">${dateStr}</div>
                    `;
                } else {
                    const high = Math.max(...dayScores);
                    const low = Math.min(...dayScores);
                    const avg = Math.round(dayScores.reduce((a, b) => a + b, 0) / dayScores.length);

                    // æŸ±å­çµ•å°ä½ç½®
                    const barBottom = (low / globalMax * 100).toFixed(1);
                    const barTop = (high / globalMax * 100).toFixed(1);
                    const barHeight = (barTop - barBottom).toFixed(1);
                    // å¹³å‡ç·šçµ•å°ä½ç½®
                    const avgPos = (avg / globalMax * 100).toFixed(1);

                    const isCrown = (date === crownDate);
                    const hasRange = high !== low;

                    div.innerHTML = `
                        <div class="stock-bar-area">
                            <div class="stock-value" style="bottom:${barTop}%">${isCrown ? 'ğŸ‘‘ ' : ''}${high}</div>
                            ${hasRange ? `<div class="stock-bar" style="height:${barHeight}%;bottom:${barBottom}%"></div>` : ''}
                            <div class="stock-avg-line" style="bottom:${avgPos}%"></div>
                        </div>
                        <div class="stock-date">${dateStr}</div>
                    `;
                }
                container.appendChild(div);
            });

            // æ»¾å‹•åˆ°æœ€å³é‚Šï¼ˆæœ€æ–°æ—¥æœŸï¼‰
            const scrollArea = document.querySelector('.stock-scroll');
            if (scrollArea) {
                scrollArea.scrollLeft = scrollArea.scrollWidth;

                // æ»‘é¼ æ»¾è¼ª â†’ æ°´å¹³æ»¾å‹•
                scrollArea.onwheel = (e) => {
                    if (e.deltaY !== 0) {
                        e.preventDefault();
                        scrollArea.scrollLeft += e.deltaY;
                    }
                };
            }
        }

        function confirmReset() {
            playSound('tap');
            showModal(STRINGS.deleteConfirm1, 'images/owl_surprised.webp', () => {
                playSound('tap');
                showModal(STRINGS.deleteConfirm2, 'images/owl_crying_sad.webp', () => {
                    playSound('tap');
                    localStorage.removeItem(STATS_KEY);
                    localStorage.removeItem(SCORES_KEY);
                    localStorage.removeItem(ERROR_POOL_KEY);
                    closeModal();
                    switchTab('errors');
                });
            });
        }

        function showModal(text, owlImage, onConfirm) {
            document.getElementById('modalText').textContent = text;
            document.getElementById('modalOwl').src = owlImage;
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('modalConfirm').onclick = onConfirm;
        }

        function closeModal() {
            playSound('tap');
            document.getElementById('confirmModal').classList.add('hidden');
        }

        // é–‹ç™¼ç”¨ï¼šå¡ 7 å¤©å‡è³‡æ–™
        function seedDemoData() {
            const now = Date.now();
            const day = 24 * 60 * 60 * 1000;
            const scores = [];
            for (let d = 6; d >= 0; d--) {
                const baseTime = now - d * day;
                // æ¯å¤© 2-4 å ´ï¼Œåˆ†æ•¸åœ¨ 100-500 ä¹‹é–“æ³¢å‹•
                const games = 2 + Math.floor(Math.random() * 3);
                for (let g = 0; g < games; g++) {
                    scores.push({
                        score: 150 + Math.floor(Math.random() * 300),
                        time: baseTime + g * 3600000
                    });
                }
            }
            saveScores(scores);
            console.log('å·²å¡å…¥ 7 å¤©å‡è³‡æ–™ï¼Œå…±', scores.length, 'ç­†');
            if (document.getElementById('statsScreen').style.display !== 'none') {
                renderScoreChart();
            }
        }
    </script>
</body>
</html>
